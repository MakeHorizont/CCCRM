
# Спецификация API: Человеческий Капитал (HR & Payroll)

## Общие сведения
Модуль отвечает за управление кадрами, учет рабочего времени и расчет вознаграждения.
Принцип: **"Каждому по труду"**. Алгоритм расчета зарплаты должен быть прозрачным и неизменяемым.

**Base URL:** `/hr`

---

## 1. Сотрудники и Иерархия (Users)

### 1.1 Список Сотрудников
**Эндпоинт:** `GET /users`

Возвращает список пользователей с обогащенными данными (имя менеджера, текущий статус).
**Response:** `User[]`

### 1.2 Обновление Профиля (Manager/CEO)
**Эндпоинт:** `PATCH /users/:id`

Позволяет менять ставку, роль, менеджера.
**Критично:** Любое изменение финансовых полей (`dailyRate`) создает запись в Audit Log.

**Body:**
```json
{
  "dailyRate": 3000,
  "managerId": "user-1",
  "functionalRoles": ["Бригадир"]
}
```

---

## 2. Учет Времени (Attendance)

### 2.1 Начать Смену (Check-in)
**Эндпоинт:** `POST /attendance/check-in`
*Обычно вызывается с терминала в цеху.*

**Body:** `{ "userId": "user-2" }` (опционально, если вызывает админ, иначе из токена)

### 2.2 Завершить Смену (Check-out)
**Эндпоинт:** `POST /attendance/check-out`

---

## 3. Зарплата и КТУ (Payroll)

### 3.1 Расчетный Лист (Payslip)
**Эндпоинт:** `GET /payroll/:userId/payslip`

**Query:** `year=2025&month=10`

Бэкенд выполняет полный расчет "на лету":
1.  Считает рабочие дни по табелю.
2.  Считает выполненные задачи в Kanban и их сложность.
3.  Рассчитывает КТУ (Дисциплина + Качество + Выработка).
4.  Формирует итоговую сумму.

**Response:**
```json
{
  "year": 2025,
  "month": 10,
  "total": 85000,
  "lineItems": [
    { "type": "BASE", "description": "Оклад (20 смен)", "amount": 60000 },
    { "type": "TASK_BONUS", "description": "Сдельная часть (x КТУ 1.1)", "amount": 25000 }
  ]
}
```

### 3.2 Детализация КТУ
**Эндпоинт:** `GET /payroll/:userId/ktu`

Показывает, из чего сложился коэффициент.

**Response:**
```json
{
  "base": 1.0,
  "total": 1.15,
  "components": [
    { "label": "Выполнение плана", "value": 0.1, "type": "BONUS" },
    { "label": "Опоздание", "value": -0.05, "type": "PENALTY" }
  ]
}
```

### 3.3 Статистика за день (Для Киоска)
**Эндпоинт:** `GET /payroll/:userId/daily-stats`

Возвращает оперативные данные: сколько заработано "прямо сейчас".

**Response:**
```json
{
  "hoursWorked": 4.5,
  "earnedBase": 1500,
  "earnedBonus": 300,
  "currentKTU": 1.0
}
```
